# Microsite Template Pattern

## Concept

A **microsite template** is a reusable pattern for creating microsites with similar characteristics. Instead of each microsite being a unique implementation, templates define how a type of microsite behaves and is integrated into the portal.

## The MkDocs Template

MkDocs is the first template example. Rather than "mkdocs" being a single microsite, it's a **template pattern** that can be instantiated multiple times:

```yaml
# Portal config shows three MkDocs instances
microsites:
  - id: "sz_docs_portal"
    microsite_type: "mkdocs"
    docs_source: "schedule-zero/docs/portal"
    path: "/docs/portal"
    
  - id: "sz_docs_frontend"
    microsite_type: "mkdocs"
    docs_source: "schdulezero-islands/docs"
    path: "/docs/frontend"
    
  - id: "sz_docs_handlers"
    microsite_type: "mkdocs"
    docs_source: "schedule-zero/docs/handlers"
    path: "/docs/handlers"
```

## Why Templates?

### Problem: Code Duplication
Without templates, each microsite implements similar functionality independently:
- Three separate MkDocs sites → three separate configurations
- Each handler project has its own docs → many duplicate setups
- Portal doesn't know how to integrate new doc sites

### Solution: Template Pattern
Templates define behavior once, instantiate many times:
- One MkDocs template → many doc sites
- Portal knows how to integrate all mkdocs-type microsites
- Adding new docs is just configuration, not code

## Microsite Types

### Type: `htmx`
**Characteristics:**
- Dynamic content loaded via HTMX
- Integrated into portal layout (loads into `#content` div)
- Server-rendered Jinja2 templates
- Shares portal navigation and chrome

**Example:**
```yaml
- id: "sz_schedules"
  microsite_type: "htmx"
  path: "/schedules"
  enabled: true
```

**Portal Behavior:**
- Clicking nav link triggers `hx-get="/schedules"`
- Tornado renders `schedules_list.html`
- HTML swapped into `#content` div
- URL updates to `/schedules`

### Type: `mkdocs`
**Characteristics:**
- Static HTML generated by MkDocs
- Served from own directory
- External navigation (MkDocs nav, not portal nav)
- Can be built/deployed independently

**Example:**
```yaml
- id: "sz_docs_frontend"
  microsite_type: "mkdocs"
  path: "/docs/frontend"
  docs_source: "schdulezero-islands/docs"
  site_dir: "schdulezero-islands/site"
```

**Portal Behavior:**
- Nav link opens in new tab OR iframe
- MkDocs site serves from `/docs/frontend/`
- Static files served by Tornado StaticFileHandler
- Independent of portal layout

### Type: `external`
**Characteristics:**
- External URL (different domain/port)
- Opens in new tab
- Not integrated into portal

**Example:**
```yaml
- id: "grafana"
  microsite_type: "external"
  path: "https://grafana.example.com"
  external_url: true
```

## Template Implementation

### Portal Handler Logic

```python
class PortalConfigHandler(RequestHandler):
    def get(self):
        config = yaml.safe_load(open('portal_config.yaml'))
        
        microsites = []
        for ms in config['microsites']:
            if not ms.get('enabled', True):
                continue
                
            microsite = {
                'id': ms['id'],
                'name': ms['name'],
                'path': ms['path'],
                'type': ms['microsite_type']
            }
            
            # Add type-specific metadata
            if ms['microsite_type'] == 'mkdocs':
                microsite['external'] = True
                microsite['target'] = '_blank'  # Open in new tab
                # OR: microsite['iframe'] = True  # Show in iframe
                
            elif ms['microsite_type'] == 'htmx':
                microsite['hx_get'] = ms['path']
                microsite['hx_target'] = '#content'
                microsite['hx_push_url'] = True
                
            elif ms['microsite_type'] == 'external':
                microsite['external'] = True
                microsite['url'] = ms['path']
                microsite['target'] = '_blank'
                
            microsites.append(microsite)
            
        self.write({'microsites': microsites})
```

### sz-nav Component Logic

```typescript
class SzNav extends HTMLElement {
  private render() {
    const html = this.config.microsites.map(ms => {
      if (ms.type === 'htmx') {
        // HTMX-powered microsite
        return `
          <a href="${ms.path}"
             hx-get="${ms.path}"
             hx-target="#content"
             hx-push-url="true">
            ${ms.icon} ${ms.name}
          </a>`;
      }
      
      if (ms.type === 'mkdocs') {
        // Static docs site
        return `
          <a href="${ms.path}"
             target="_blank"
             rel="noopener">
            ${ms.icon} ${ms.name} ↗
          </a>`;
      }
      
      if (ms.type === 'external') {
        // External link
        return `
          <a href="${ms.url}"
             target="_blank"
             rel="noopener noreferrer">
            ${ms.icon} ${ms.name} ↗
          </a>`;
      }
    }).join('');
    
    this.shadow.innerHTML = `<nav>${html}</nav>`;
  }
}
```

## Documentation Structure

Each project/component can have its own `docs/` folder:

```
schedule-zero/
├── docs/
│   ├── portal/           ← Portal docs (mkdocs instance 1)
│   │   ├── mkdocs.yml
│   │   ├── index.md
│   │   └── architecture.md
│   └── handlers/         ← Handler docs (mkdocs instance 2)
│       ├── mkdocs.yml
│       ├── index.md
│       └── handler-api.md
│
schdulezero-islands/
└── docs/                 ← Frontend docs (mkdocs instance 3)
    ├── mkdocs.yml
    ├── index.md
    ├── architecture.md
    └── component-patterns.md

schdulezero-handlers-python/
└── docs/                 ← Python handlers docs (mkdocs instance 4)
    ├── mkdocs.yml
    └── index.md
```

## Building Multiple MkDocs Sites

### Build Script: `build-all-docs.sh`
```bash
#!/bin/bash

# Build portal docs
cd schedule-zero/docs/portal
mkdocs build --site-dir ../../../static/docs/portal

# Build handler docs
cd ../handlers
mkdocs build --site-dir ../../../static/docs/handlers

# Build frontend docs
cd ../../../schdulezero-islands
mkdocs build --site-dir ../schedule-zero/static/docs/frontend

echo "✓ All documentation sites built"
```

### Tornado Static File Handler
```python
# Serve all doc sites from /docs/*
app.add_handlers(r".*", [
    (r"/docs/portal/(.*)", StaticFileHandler, {
        "path": "static/docs/portal",
        "default_filename": "index.html"
    }),
    (r"/docs/frontend/(.*)", StaticFileHandler, {
        "path": "static/docs/frontend",
        "default_filename": "index.html"
    }),
    (r"/docs/handlers/(.*)", StaticFileHandler, {
        "path": "static/docs/handlers",
        "default_filename": "index.html"
    }),
])
```

## Adding New Templates

To add a new template type (e.g., `streamlit` for data apps):

### 1. Update Configuration Schema
```yaml
microsites:
  - id: "data_viz"
    microsite_type: "streamlit"
    path: "/viz"
    streamlit_port: 8501
    enabled: true
```

### 2. Add Portal Handler Logic
```python
elif ms['microsite_type'] == 'streamlit':
    microsite['iframe'] = True
    microsite['iframe_src'] = f"http://localhost:{ms['streamlit_port']}"
```

### 3. Update sz-nav Component
```typescript
if (ms.type === 'streamlit') {
  return `
    <a href="${ms.path}" data-iframe="${ms.iframe_src}">
      ${ms.icon} ${ms.name}
    </a>`;
}
```

### 4. Add Portal Integration
```html
<!-- Portal layout.html -->
<script>
  document.addEventListener('click', (e) => {
    if (e.target.hasAttribute('data-iframe')) {
      const src = e.target.getAttribute('data-iframe');
      showIframe(src);
    }
  });
</script>
```

## Benefits of Template Pattern

1. **Consistency** - All microsites of same type behave the same
2. **Maintainability** - Update template logic in one place
3. **Discoverability** - Portal automatically understands new instances
4. **Scalability** - Easy to add new microsite instances
5. **Documentation** - Each project can have its own docs that integrate seamlessly

## Real-World Example: Handler Projects

```yaml
# Portal config for multiple handler projects
microsites:
  # Each handler project has its own docs
  - id: "handlers_python_docs"
    name: "Python Handlers"
    microsite_type: "mkdocs"
    docs_source: "schdulezero-handlers-python/docs"
    path: "/docs/handlers/python"
    
  - id: "handlers_rust_docs"
    name: "Rust Handlers"
    microsite_type: "mkdocs"
    docs_source: "schdulezero-handlers-rust/docs"
    path: "/docs/handlers/rust"
    
  - id: "handlers_go_docs"
    name: "Go Handlers"
    microsite_type: "mkdocs"
    docs_source: "schdulezero-handlers-go/docs"
    path: "/docs/handlers/go"
```

Portal automatically:
- Builds all docs during deployment
- Serves them from appropriate paths
- Shows them in navigation with proper icons
- Opens them in new tabs (external links)

No custom code needed - just configuration!
